<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>Conway's Game of Life</title>
    <script src="./d3.v3.min.js"></script>
    <style type="text/css" media="all">
      html {
        height: 100%;
      }
      body {
        height: 100%;
        margin: 0 auto;
      }
      rect.live {
        fill: slategrey;
      }
      rect.dead {
        stroke: #70DBD1;
        stroke-width: 0.1;
        fill: transparent;
      }
      rect.new {
        fill: #CB60E6;
      }
      rect.dead:hover {
        fill: #CCFFFF;
      }
    </style>
  </head>
  <body>
    <script type="text/javascript" charset="utf-8">
      var GliderSeed = [
        {Row: 2, Col: 1},
        {Row: 2, Col: 2},
        {Row: 2, Col: 3},
        {Row: 1, Col: 3},
        {Row: 0, Col: 2}
      ];

      var GosperGliderGun = [
        {Row: 5, Col: 1},
        {Row: 5, Col: 2},
        {Row: 6, Col: 1},
        {Row: 6, Col: 2},
        {Row: 3, Col: 13},
        {Row: 3, Col: 14},
        {Row: 4, Col: 12},
        {Row: 4, Col: 16},
        {Row: 5, Col: 11},
        {Row: 5, Col: 17},
        {Row: 6, Col: 11},
        {Row: 6, Col: 15},
        {Row: 6, Col: 17},
        {Row: 6, Col: 18},
        {Row: 7, Col: 11},
        {Row: 7, Col: 17},
        {Row: 8, Col: 12},
        {Row: 8, Col: 16},
        {Row: 9, Col: 13},
        {Row: 9, Col: 14},
        {Row: 1, Col: 25},
        {Row: 2, Col: 23},
        {Row: 2, Col: 25},
        {Row: 3, Col: 21},
        {Row: 3, Col: 22},
        {Row: 4, Col: 21},
        {Row: 4, Col: 22},
        {Row: 5, Col: 21},
        {Row: 5, Col: 22},
        {Row: 6, Col: 23},
        {Row: 6, Col: 25},
        {Row: 7, Col: 25},
        {Row: 3, Col: 35},
        {Row: 3, Col: 36},
        {Row: 4, Col: 35},
        {Row: 4, Col: 36}
      ];

      var diehard = [
        {Row: 50, Col: 50},
        {Row: 50, Col: 51},
        {Row: 51, Col: 51},
        {Row: 49, Col: 56},
        {Row: 51, Col: 55},
        {Row: 51, Col: 56},
        {Row: 51, Col: 57},
      ];

      var beacon = [
        {Row: 40, Col: 40},
        {Row: 40, Col: 41},
        {Row: 41, Col: 40},
        {Row: 43, Col: 42},
        {Row: 43, Col: 43},
        {Row: 42, Col: 43},
      ];

      var cells_in_row = 150;
      window.onresize = function() {
        svg.attr("width", window.innerWidth).attr("height", window.innerHeight);

        x = d3.scale.linear().domain([0, cells_in_row-1]).rangeRound([0, window.innerWidth]);
        y = d3.scale.linear().domain([0, window.innerHeight / x(1)]).rangeRound([0, window.innerHeight]);

        svg.selectAll('rect')
          .attr('width', function(d) { return x(1) })
          .attr('height', function(d) { return y(1) })
          .attr('x', function(d) { return x(d.Col) })
          .attr('y', function(d) { return y(d.Row) });
      }

      var x = d3.scale.linear().domain([0, cells_in_row-1]).rangeRound([0, window.innerWidth]);
      var y = d3.scale.linear().domain([0, window.innerHeight / x(1)]).rangeRound([0, window.innerHeight]);

      var grid = [];
      // XXX Why swapping two fors fucks things up???
      for (var ey = 0; ey < window.innerHeight/x(1); ey++) {
        for (var ex = 0; ex < cells_in_row; ex++) {
          grid.push({Row: ey, Col: ex});
        }
      }

      var svg = d3.select("body").append("svg")
        .attr("width", window.innerWidth)
        .attr("height", window.innerHeight);

      svg.selectAll('rect').data(grid)
        .enter().append('rect')
        .on('mousedown', startSelection)
        .on('mousemove', addCellToSelection)
        .on('mouseup', finishSelection)
        .attr('width', function(d) { return x(1) })
        .attr('height', function(d) { return y(1) })
        .attr('class', 'dead')
        .attr('x', function(d) { return x(d.Col) })
        .attr('y', function(d) { return y(d.Row) });

      var selection = [], selection_in_progress = false;
      function startSelection() {
        selection_in_progress = true;
      }
      function addCellToSelection(data) {
        if (selection_in_progress) {
          d3.select(this).attr('class', 'new');
          selection.push(data);
        }
      }
      function finishSelection(data) {
        selection_in_progress = false
      }

      var renderNextGeneration = function(data) {
        var data_plus_selection = data;
        if (!selection_in_progress && selection.length > 0) {
          data_plus_selection = data.concat(selection);
          selection = [];
        }

        var rect = svg.selectAll('rect').data(data_plus_selection, function(d) {
          return String(d.Row) + String(d.Col);
        });

        var calculateLiveClass = function(d) {
          if (selection_in_progress && d3.select(this).attr('class') == 'new') {
            return 'new';
          }
          return 'live';
        };
        var calculateDeadClass = function(d) {
          if (selection_in_progress && d3.select(this).attr('class') == 'new') {
            return 'new';
          }
          return 'dead';
        }

        rect.attr('class', calculateLiveClass);
        rect.exit().attr('class', calculateDeadClass);

        return data_plus_selection;
      };

      var ws = new WebSocket("ws://" + window.location.host + "/go-ws");

      ws.onopen = function() {
        ws.send(JSON.stringify(GosperGliderGun));
      }

      ws.onclose = function(e) {
        console.log("connection closed: ", e);
      }

      ws.onmessage = function(event) {
        var breed = renderNextGeneration(JSON.parse(event.data));

        setTimeout(function() {
            ws.send(JSON.stringify(breed));
        }, 100);
      }
    </script>

  </body>
</html>
